---
procyamlversion: 3.0.0-dev.0

description: XCP-D, https://xcp-d.readthedocs.io/en/latest

jobtemplate: job_template_v3.txt

containers:
  - name: xcpd
    path: xcp_d_0.7.5.sif
    source: docker://pennlinc/xcp_d:0.7.5

requirements:
  walltime: 1-0
  memory: 8G

inputs:
  xnat:
      
    filters:
      - type: match
        inputs: scan_fmri,assr_fmriprep/scan_fmri
      - type: match
        inputs: scan_fmri,assr_bwt/scan_fmri
      - type: match
        inputs: assr_fmriprep/scan_fmri,assr_bwt/scan_fmri

    scans:

      - name: scan_fmri
        types: 'Resting state'

    assessors:
        
        - name: assr_fmriprep
          proctypes: fmriprep_v24
          resources:
            - {resource: fmriprepBIDS, ftype: DIR, fdest: fmriprepBIDS}

        - name: assr_bwt
          proctypes: bwt-docker_v1
          resources:
            - {resource: DESPIKED, ftype: FILE, fdest: wdsfmri.nii.gz}

outputs:
  - {path: HTML, type: DIR, resource: HTML}
  - {path: xcpdBIDS, type: DIR, resource: xcpdBIDS}
  - {path: qc.csv, type: FILE, resource: QC}
  - {path: COVERAGE, type: DIR, resource: COVERAGE}


# First copy the wavelet filtered image into fmriprep dir
# Note we are OVERWRITING the original preproc 
pre:
  type: singularity_exec
  container: xcpd
  args: >-
    bash -c \"
    preproc_niigz=\\\$(ls /INPUTS/fmriprepBIDS/fmriprepBIDS/sub-*/ses-*/func/*_space-MNI152NLin2009cAsym_desc-preproc_bold.nii.gz) &&
    cp /INPUTS/wdsfmri.nii.gz \\\$preproc_niigz
    \"

# Not overwriting - issue with filename tags?
#  args: >-
#    bash -c \"
#    preproc_niigz=\\\$(ls /INPUTS/fmriprepBIDS/fmriprepBIDS/sub-*/ses-*/func/*_space-MNI152NLin2009cAsym_desc-preproc_bold.nii.gz) &&
#    wds_niigz=\\\$(echo \\\$preproc_niigz | sed 's/desc-preproc_bold/desc-wds_bold/') &&
#    cp /INPUTS/wdsfmri.nii.gz \\\$wds_niigz &&
#    echo '{{ \\\"bold\\\": {{ \\\"desc\\\": [\\\"wds\\\"] }} }}' 
#      > /INPUTS/bids-filter-file.json
#    \"


# Run xcpd proper
#        --bids-filter-file /INPUTS/bids-filter-file.json
command:
  type: singularity_run
  container: xcpd
  args: >-
    --work-dir /tmp
    --fs-license-file /opt/license.txt
    --skip-dcan-qc
    --smoothing 0
    --atlases Gordon
    --nuisance-regressors acompcor
    --fd-thresh 0
    --disable-bandpass-filter
    --min-coverage 0.5
    /INPUTS/fmriprepBIDS/fmriprepBIDS
    /OUTPUTS/xcpdBIDS
    participant
  extraopts: --bind /data/mcr/centos7/FS6/license.txt:/opt/license.txt


# Additional connectivity processing
post:
  type: singularity_exec
  container: xcpd
  args: >-
    bash -c '
    mkdir /OUTPUTS/HTML &&
    cp /OUTPUTS/xcpdBIDS/sub-*.html /OUTPUTS/HTML &&
    cp -R /OUTPUTS/xcpdBIDS/sub-* /OUTPUTS/HTML &&
    rm -fr /OUTPUTS/HTML/sub-*/ses-* &&
    
    cd /INPUTS &&
    curl -o xcpd-processors.tar.gz -L https://github.com/VUIIS/xcpd-processors/archive/refs/tags/v2.3.1.tar.gz &&
    tar -zxf xcpd-processors.tar.gz &&
    export PATH=/INPUTS/xcpd-processors-2.3.1/scripts:\$PATH &&

    stats_csvs.py --xcpd_dir /OUTPUTS/xcpdBIDS --out_dir /OUTPUTS --atlas Gordon &&

    fisher_z.py --xcpd_dir /OUTPUTS/xcpdBIDS
    '
